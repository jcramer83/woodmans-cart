<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self' ws://localhost:* ws://*:3456" />
  <title>Woodmans Cart</title>
  <link rel="icon" type="image/png" href="/assets/icon.png" />
  <!-- iOS home screen icon & web app meta -->
  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Woodmans" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <div class="header-brand">
      <svg class="logo" viewBox="0 0 40 40" width="32" height="32" xmlns="http://www.w3.org/2000/svg">
        <path d="M20 8 C18 4, 14 2, 16 6 C14 4, 12 5, 14 8" fill="#4caf50" stroke="#388e3c" stroke-width="0.5"/>
        <rect x="19" y="6" width="2" height="5" rx="1" fill="#795548"/>
        <path d="M20 10 C12 10, 6 16, 6 24 C6 32, 12 38, 20 38 C28 38, 34 32, 34 24 C34 16, 28 10, 20 10 Z" fill="#e53935"/>
        <ellipse cx="15" cy="18" rx="4" ry="3" fill="#ef5350" opacity="0.6"/>
      </svg>
      <h1>Woodman's Cart</h1>
      <span id="shopping-mode-badge" class="badge mode-badge mode-toggle" onclick="toggleShoppingMode()" title="Click to switch shopping mode">In-Store</span>
    </div>
    <div style="display:flex;align-items:center;gap:6px;-webkit-app-region:no-drag;">
      <button id="btn-dark-mode" class="btn-icon" onclick="toggleDarkMode()" title="Toggle dark mode">&#9790;</button>
    </div>
  </header>

  <!-- Main layout -->
  <main class="main-grid">
    <!-- Left column -->
    <div class="left-col">
      <!-- Staples section -->
      <section class="section">
        <div class="section-header">
          <h2>Weekly Staples</h2>
          <div class="section-actions">
            <button id="btn-add-all-staples" class="btn btn-sm">Add All to Cart</button>
            <button id="btn-add-staple" class="btn btn-sm btn-accent">+ Add</button>
          </div>
        </div>
        <div id="staples-list" class="item-list">
          <p class="empty-state">No staples yet. Click "+ Add" to get started.</p>
        </div>
      </section>

      <!-- Recipes section -->
      <section class="section">
        <div class="section-header">
          <h2>Recipes</h2>
          <div class="section-actions">
            <button id="btn-ai-recipe" class="btn btn-sm" title="Generate recipe with AI">AI Recipe</button>
            <button id="btn-add-recipe" class="btn btn-sm btn-accent">+ Add</button>
          </div>
        </div>
        <div id="recipes-list" class="item-list">
          <p class="empty-state">No recipes yet. Click "+ Add" to create one.</p>
        </div>
      </section>
    </div>

    <!-- Right column -->
    <div class="right-col">
      <!-- Cart section -->
      <section class="section">
        <div class="section-header">
          <h2>Shopping Cart <span id="cart-count" class="badge">0</span> <span id="cart-estimate" class="cart-estimate"></span></h2>
          <button id="btn-clear-cart" class="btn btn-sm">Clear All</button>
        </div>
        <div id="cart-list" class="item-list cart-list">
          <p class="empty-state">Cart is empty. Add staples or enable recipes to populate.</p>
        </div>
        <!-- Manual item add row -->
        <div class="manual-add-row">
          <input type="text" id="manual-item-name" placeholder="Add item manually..." />
          <input type="number" id="manual-item-qty" value="1" min="1" max="99" />
          <button id="btn-manual-search" class="btn btn-sm" title="Search Woodmans">&#128269;</button>
          <button id="btn-manual-add" class="btn btn-sm btn-accent">Add</button>
        </div>
        <div id="manual-search-area" style="display:none;">
          <div class="product-search-input-row">
            <input type="text" id="manual-search-query" placeholder="Search Woodmans..." />
            <button id="btn-manual-search-go" class="btn btn-sm">Search</button>
          </div>
          <div id="manual-search-results" class="product-results">
            <p class="empty-state">Enter a search term and click Search.</p>
          </div>
        </div>
      </section>

      <!-- Action section -->
      <section class="section action-section">
        <div class="action-buttons">
          <button id="btn-start-cart" class="btn btn-lg btn-accent">Add to Woodmans Cart</button>
          <button id="btn-stop-cart" class="btn btn-lg btn-danger" style="display:none;">Stop</button>
        </div>
        <div id="cart-progress" class="cart-progress" style="display:none;">
          <div class="cart-progress-track">
            <div id="cart-progress-fill" class="cart-progress-fill"></div>
          </div>
          <span id="cart-progress-label" class="cart-progress-label">0 / 0 items (0%)</span>
        </div>
        <div id="cart-activity" class="activity-bar"><div class="activity-bar-fill"></div></div>
        <div id="cart-activity-status" class="activity-status"></div>
        <div id="progress-log" class="progress-log">
          <p class="empty-state">Progress will appear here...</p>
        </div>
      </section>

      <!-- Current Woodmans Online Cart section -->
      <section class="section">
        <div class="section-header">
          <h2>Current Woodmans Cart <span id="online-cart-count" class="badge">0</span> <span id="online-cart-estimate" class="cart-estimate"></span></h2>
          <div class="section-actions">
            <button class="btn-icon" onclick="openExternalUrl('https://shopwoodmans.com/store/woodmans-food-markets/storefront')" title="Open Woodmans Store">&#128722;</button>
            <button id="btn-remove-all-online" class="btn btn-sm btn-danger" style="display:none;">Remove All</button>
            <button id="btn-import-cart" class="btn btn-sm">Refresh</button>
          </div>
        </div>
        <div id="online-cart-activity" class="activity-bar"><div class="activity-bar-fill"></div></div>
        <div id="online-cart-activity-status" class="activity-status"></div>
        <div id="online-cart-list" class="item-list">
          <p class="empty-state">Click "Refresh" to load your current Woodmans online cart.</p>
        </div>
      </section>
    </div>
  </main>

  <!-- Staple Edit Modal -->
  <div id="modal-staple" class="modal-overlay" style="display:none;">
    <div class="modal">
      <div class="modal-header">
        <h3 id="staple-modal-title">Add Staple</h3>
        <button class="btn-close" data-close="modal-staple">&times;</button>
      </div>
      <div class="modal-body">
        <label>
          Item Name
          <input type="text" id="staple-item" placeholder="e.g. whole milk" />
        </label>
        <label>
          Quantity
          <input type="number" id="staple-quantity" value="1" min="1" max="99" />
        </label>
        <label>
          Note
          <input type="text" id="staple-note" placeholder="e.g. half gallon" />
        </label>
        <div class="product-search-section">
          <label>Product / Brand</label>
          <div class="product-search-row">
            <input type="text" id="staple-product-name" placeholder="Selected product name" readonly />
            <button id="btn-find-product" class="btn btn-sm">Find Product</button>
          </div>
          <div id="product-search-area" style="display:none;">
            <div class="product-search-input-row">
              <input type="text" id="product-search-query" placeholder="Search Woodmans..." />
              <button id="btn-product-search-go" class="btn btn-sm">Search</button>
            </div>
            <div id="product-search-results" class="product-results">
              <p class="empty-state">Enter a search term and click Search.</p>
            </div>
          </div>
        </div>
        <label>
          Brand
          <input type="text" id="staple-brand" placeholder="e.g. Organic Valley" />
        </label>
        <input type="hidden" id="staple-price" value="" />
      </div>
      <div class="modal-footer">
        <button class="btn" data-close="modal-staple">Cancel</button>
        <button id="btn-save-staple" class="btn btn-accent">Save</button>
      </div>
    </div>
  </div>

  <!-- Recipe Edit Modal -->
  <div id="modal-recipe" class="modal-overlay" style="display:none;">
    <div class="modal modal-wide">
      <div class="modal-header">
        <h3 id="recipe-modal-title">Add Recipe</h3>
        <button class="btn-close" data-close="modal-recipe">&times;</button>
      </div>
      <div class="modal-body">
        <label>
          Recipe Name
          <input type="text" id="recipe-name" placeholder="e.g. Beef Mac & Cheese" />
        </label>
        <div class="recipe-items-section">
          <div class="section-header">
            <h4>Ingredients</h4>
            <button id="btn-add-recipe-item" class="btn btn-sm btn-accent">+ Add Item</button>
          </div>
          <div id="recipe-items-list" class="item-list">
            <p class="empty-state">No ingredients yet.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" data-close="modal-recipe">Cancel</button>
        <button id="btn-save-recipe" class="btn btn-accent">Save</button>
      </div>
    </div>
  </div>

  <!-- Recipe Item Edit Modal (for individual ingredients) -->
  <div id="modal-recipe-item" class="modal-overlay" style="display:none;">
    <div class="modal">
      <div class="modal-header">
        <h3 id="recipe-item-modal-title">Add Ingredient</h3>
        <button class="btn-close" data-close="modal-recipe-item">&times;</button>
      </div>
      <div class="modal-body">
        <label>
          Item Name
          <input type="text" id="recipe-item-name" placeholder="e.g. whole milk" />
        </label>
        <label>
          Quantity
          <input type="number" id="recipe-item-quantity" value="1" min="1" max="99" />
        </label>
        <label>
          Note
          <input type="text" id="recipe-item-note" placeholder="e.g. half gallon" />
        </label>
        <div class="product-search-section">
          <label>Product / Brand</label>
          <div class="product-search-row">
            <input type="text" id="recipe-item-product-name" placeholder="Selected product name" readonly />
            <button id="btn-recipe-item-find" class="btn btn-sm">Find Product</button>
          </div>
          <div id="recipe-item-search-area" style="display:none;">
            <div class="product-search-input-row">
              <input type="text" id="recipe-item-search-query" placeholder="Search Woodmans..." />
              <button id="btn-recipe-item-search-go" class="btn btn-sm">Search</button>
            </div>
            <div id="recipe-item-search-results" class="product-results">
              <p class="empty-state">Enter a search term and click Search.</p>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" data-close="modal-recipe-item">Cancel</button>
        <button id="btn-save-recipe-item" class="btn btn-accent">Save Ingredient</button>
      </div>
    </div>
  </div>

  <!-- AI Recipe Modal -->
  <div id="modal-ai-recipe" class="modal-overlay" style="display:none;">
    <div class="modal">
      <div class="modal-header">
        <h3>Generate Recipe with AI</h3>
        <button class="btn-close" data-close="modal-ai-recipe">&times;</button>
      </div>
      <div class="modal-body">
        <label>
          What do you want to make?
          <input type="text" id="ai-recipe-prompt" placeholder="e.g. steak tacos, chicken stir fry" />
        </label>
        <label>
          Servings
          <input type="number" id="ai-recipe-servings" value="4" min="1" max="20" />
        </label>
        <div class="ai-options">
          <label class="checkbox-label"><input type="checkbox" id="ai-gluten-free" /> Gluten Free</label>
          <label class="checkbox-label"><input type="checkbox" id="ai-dairy-free" /> Dairy Free</label>
          <label class="checkbox-label"><input type="checkbox" id="ai-prefer-organic" /> Prefer Organic</label>
        </div>
        <div id="ai-recipe-status" class="ai-status" style="display:none;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" data-close="modal-ai-recipe">Cancel</button>
        <button id="btn-ai-generate" class="btn btn-accent">Generate</button>
      </div>
    </div>
  </div>

  <!-- View Recipe Modal -->
  <div id="modal-view-recipe" class="modal-overlay" style="display:none;">
    <div class="modal modal-wide">
      <div class="modal-header">
        <h3 id="view-recipe-title">Recipe</h3>
        <button class="btn-close" data-close="modal-view-recipe">&times;</button>
      </div>
      <div class="modal-body" id="view-recipe-body">
        <p id="view-recipe-servings" class="recipe-view-servings"></p>
        <h4>Ingredients</h4>
        <ul id="view-recipe-ingredients" class="recipe-view-ingredients"></ul>
        <h4>Instructions</h4>
        <ol id="view-recipe-instructions" class="recipe-view-instructions"></ol>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="printRecipe()">Print</button>
        <button class="btn btn-accent" data-close="modal-view-recipe">Close</button>
      </div>
    </div>
  </div>

  <script src="api-adapter.js"></script>
  <script src="app.js"></script>
</body>
</html>
